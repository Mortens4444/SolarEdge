@page "/"
@using Microsoft.Maui.Storage
@using SolarEdge.Models
@using System.Net
@inject HttpClient Http

<div class="d-flex justify-content-between align-items-center mb-1">
    <h1>SolarEdge Monitor</h1>
    <button class="btn btn-outline-secondary btn-sm" @onclick="RefreshData">
        <i class="bi bi-arrow-clockwise"></i> Reload Data
    </button>
</div>

@if (lastRefresh.HasValue)
{
    <p class="text-muted small mb-3">Last updated: @lastRefresh.Value.ToString("yyyy-MM-dd HH:mm:ss")</p>
}

@if (site == null)
{
    <div class="alert alert-info">@message</div>
}
else
{
    @* --- ALERTS SECTION --- *@
    @if (!String.IsNullOrEmpty(alertsErrorMessage))
    {
        <div class="alert alert-warning shadow-sm mb-4">
            <h6 class="mb-1"><i class="bi bi-exclamation-circle"></i> Alerts Module Error</h6>
            <small>@alertsErrorMessage</small>
        </div>
    }
    else if (alerts != null && alerts.Any())
    {
        <div class="alert alert-danger shadow-sm mb-4">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Active Alerts (@alerts.Count)</h4>
            @foreach (var alert in alerts)
            {
                <div class="p-2 border-bottom border-danger-subtle">
                    <div class="d-flex justify-content-between font-weight-bold">
                        <span>@alert.Name</span>
                        <span class="badge bg-danger">@alert.Severity</span>
                    </div>
                    <small>@alert.Description</small>
                </div>
            }
        </div>
    }

    @* --- INVERTER REAL-TIME DATA --- *@
    <div class="card shadow-sm mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h6 class="mb-0"><i class="bi bi-lightning-charge"></i> Inverter Telemetry (Last Hour)</h6>
        </div>
        <div class="card-body">
            @if (!String.IsNullOrEmpty(inverterErrorMessage))
            {
                <div class="text-danger small">@inverterErrorMessage</div>
            }
            else if (inverterDetails.Any())
            {
                var latest = inverterDetails.First();
                <div class="row text-center">
                    <div class="col-4">
                        <small class="text-muted d-block">AC Power</small>
                        <strong>@latest.TotalActivePower W</strong>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block">DC Voltage</small>
                        <strong>@latest.DcVoltage V</strong>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block">Temp</small>
                        <strong>@latest.Temperature °C</strong>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-top extra-small text-muted text-center">
                    Last reading: @latest.Date
                </div>
            }
            else
            {
                <div class="text-muted small">No recent telemetry data available.</div>
            }
        </div>
    </div>

    @* --- MAIN SITE DETAILS --- *@
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between">
            <h5 class="mb-0">@site.Name</h5>
        </div>
        <div class="card-body">
            <span class="badge @(site.Status == "Active" ? "bg-success" : "bg-warning text-dark")">
                @site.Status
            </span>
            <div class="row">
                <div class="col-6 border-end">
                    <p class="mb-1 text-muted small">System Info</p>
                    <strong>ID:</strong> @site.Id<br />
                    <strong>Type:</strong> @site.Type<br />
                    <strong>Power:</strong> @site.PeakPower kWp<br />
                </div>
                <div class="col-6 ps-3">
                    <p class="mb-1 text-muted small">Alarms Info</p>
                    <strong>Quantity:</strong> @site.AlertQuantity<br />
                    <strong>Impact Score:</strong> @site.HighestImpact
                </div>
            </div>
        </div>
    </div>

    @* --- PRIMARY MODULE --- *@
    <div class="card shadow-sm mb-4 border-info">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="bi bi-cpu"></i> Hardware Details</h6>
        </div>
        <div class="card-body">
            <strong>Module:</strong> @site.PrimaryModule.ManufacturerName @site.PrimaryModule.ModelName<br />
            <strong>Max Power:</strong> @site.PrimaryModule.MaximumPower W<br />
            <strong>Temp Coef:</strong> @site.PrimaryModule.TemperatureCoef %/°C
        </div>
    </div>

    @* --- LOCATION & MAP --- *@
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white">
            <h6 class="mb-0"><i class="bi bi-geo-alt"></i> Location</h6>
        </div>
        <div class="card-body small">
            <address class="mb-2">
                <strong>@site.Location.Address</strong><br />
                @if (!String.IsNullOrEmpty(site.Location.Address2))
                {
                    <span>@site.Location.Address2<br /></span>
                }
                @site.Location.Zip @site.Location.City, @site.Location.Country (@site.Location.CountryCode)
            </address>
            <hr />
            <div class="d-flex justify-content-between">
                <span><strong>Lat:</strong> @site.Location.Latitude</span>
                <span><strong>Long:</strong> @site.Location.Longitude</span>
            </div>
            <div class="text-muted mt-2"><strong>Timezone:</strong> @site.Location.TimeZone</div>
        </div>
    </div>

    @* --- QUICK LINKS (URIS) --- *@
    <div class="d-grid gap-2 mb-4">
        <a href="@FormatApiUri(site.Uris.Overview)" target="_blank" class="btn btn-outline-primary btn-sm">Open SolarEdge Overview</a>
        <a href="@FormatApiUri(site.Uris.Details)" target="_blank" class="btn btn-outline-primary btn-sm">Open SolarEdge Details</a>
        <a href="@FormatApiUri(site.Uris.Data_Period)" target="_blank" class="btn btn-outline-primary btn-sm">Open SolarEdge Data Period</a>
    </div>
}

@code {
    private string baseUrl = "https://monitoringapi.solaredge.com";
    private string? siteId;
    private string? inverterSerialNumber;
    private string? apiKey;
    private Site? site;
    private List<Alert> alerts = new();
    private string message = "Loading data...";
    private string? alertsErrorMessage;
    private DateTime? lastRefresh;
    private List<InverterTelemetry> inverterDetails = new();
    private string? inverterErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
    }

    private async Task RefreshData()
    {
        site = null;
        alerts.Clear();
        alertsErrorMessage = null;
        message = "Updating data...";

        siteId = await SecureStorage.Default.GetAsync("site_id");
        inverterSerialNumber = await SecureStorage.Default.GetAsync("inverter_serial_number");
        apiKey = await SecureStorage.Default.GetAsync("api_key");

        if (String.IsNullOrEmpty(siteId) || String.IsNullOrEmpty(apiKey))
        {
            message = "Missing API settings!";
            return;
        }

        try
        {
            await GetSiteDetails();
            if (site != null)
            {
                await GetAlerts();
                await GetInverterData();
            }
            lastRefresh = DateTime.Now;
        }
        catch (Exception ex)
        {
            message = "Error: " + ex.Message;
        }
    }

    private async Task GetSiteDetails()
    {
        var url = $"{baseUrl}/site/{siteId}/details?api_key={apiKey}";
        var response = await Http.GetFromJsonAsync<SolarEdgeResponse>(url);
        site = response?.Details;
    }

    private async Task GetAlerts()
    {
        try
        {
            var url = $"{baseUrl}/site/{siteId}/alerts?api_key={apiKey}";
            var response = await Http.GetFromJsonAsync<AlertsResponse>(url);
            if (response?.Alerts?.Content != null)
            {
                alerts = response.Alerts.Content;
            }
        }
        catch (Exception ex)
        {
            alertsErrorMessage = $"Alerts unavailable: {ex.Message}";
            Console.WriteLine("Alerts API call failed.");
        }
    }

    private async Task GetInverterData()
    {
        try
        {
            // Inventory lekérése a szériaszám miatt
            var invUrl = $"{baseUrl}/site/{siteId}/inventory?api_key={apiKey}";
            var inventoryRes = await Http.GetFromJsonAsync<InventoryResponse>(invUrl);
            var inverter = inventoryRes?.Inventory?.Inverters?.FirstOrDefault();

            if (inverter != null)
            {
                var storedSerial = await SecureStorage.Default.GetAsync("inverter_serial_number");
                var serial = String.IsNullOrEmpty(inverter.SerialNumber) ? storedSerial : inverter.SerialNumber;

                if (String.IsNullOrEmpty(serial))
                {
                    return;
                }

                var startTime = DateTime.Now.AddHours(-1).ToString("yyyy-MM-dd HH:mm:ss");
                var endTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");

                var dataUrl = $"{baseUrl}/equipment/{siteId}/{serial}/data?startTime={startTime}&endTime={endTime}&api_key={apiKey}";
                var dataRes = await Http.GetFromJsonAsync<InverterDataResponse>(dataUrl);

                if (dataRes?.Data?.Telemetries != null)
                {
                    inverterDetails = dataRes.Data.Telemetries.OrderByDescending(t => t.Date).ToList();
                }
            }
        }
        catch (Exception ex)
        {
            inverterErrorMessage = $"Inverter telemetry failed: {ex.Message}";
        }
    }

    private string FormatApiUri(string uri)
    {
        if (String.IsNullOrEmpty(uri))
        {
            return "#";
        }

        // "/site/123/details"
        if (uri.StartsWith("/"))
        {
            return $"{baseUrl}{uri}?api_key={apiKey}";
        }

        // 0.0.0.1
        return uri.Replace("0.0.0.1", baseUrl);
    }
}